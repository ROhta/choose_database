## 安易に立てるな

## データベース

#### ～そのデータどこで持つ？～

太田

---

よくあるwebアプリケーションの処理フロー

---

1. データベースから取ってくる
1. サーバサイドプログラムの変数に突っ込む
1. クライアントに渡す
1. クライアントサイドプログラムの変数に突っ込む
1. 表示

---

データを保持しなきゃいけないと思うと<br/>データベースに突っ込もうとしがち

+++
@transition[slide]

## データはもっといろんなところに置ける！

---

基本戦略は

- なるべく取りに行かない
  - 取りに行くなら、なるべくフロントエンド寄りにする
- なるべく保存しない
  - 保存するなら、なるべくフロントエンド寄りにする
  - ただしセキュリティを考える

---

### データを置ける場所

- サーバサイド |
  - データストア |
    - ディスク |
    - インメモリ |
  - プログラム内 |
    - グローバル変数 |
- クライアントサイド |
  - データストア |

---

## server side

---

### datastore

- RDB
  - 列志向
  - 行志向
- KVS
- DocumentDB
- 単なるストレージ

---

### In memory data store

---

- Redis
- Memcached

---

#### 使うならRedis

- memcachedでできてRedisで出来ないことはない |
- Redisでできてmemcahedで出来ないことはある |
  - データの半永続化 |
  - レプリケーション |
  - ソート |

---

### global variable

---

データの内容によっては、グローバル変数に大容量データを突っ込んでおく実装もあり

---

- マスター情報
  - 何らかのツリー構造
    - 組織図, 検索条件, etc
- 受け付けるリクエストパラメータの種類
- 比較対象データ等
  - データAとデータBを照合させるような処理（Aはリクエスト毎に変わる、Bはリクエストに関わらず不変）
  - Bをグローバル変数に入れておく

---

ただし、気を配らないといけないポイントはある

---

- 上書き不可の定数として宣言する
- GCの設定を確認する
- スレッドセーフか確認する
- （可能であれば）ミドルウェア起動時にのみ変数への代入処理が走る実装にする

---

## client side

---

- client sideでグローバル変数に突っ込みまくるのはダメ
  - ブラウザクラッシュする
- client sideでもデータストアは使える

---

- cookie
- WebStorage
  - localStorage
  - sessionStorage
- webSQL
- IndexedDB

---

### cookie

- 保存容量4KB~~オワコン~~
- サーバにデータを自動送信
- 有効期限設定あり

---

### localStorage

- KVS
- 保存容量5MB
- データ送信しない
- **有効期限設定なし（jsで消さない限り残り続ける）**
- **同一ドメイン内で有効**

---

### sessionStorage

- KVS
- 保存容量5MB
- データ送信しない
- **有効期限設定なし（セッション内ではjsで消さない限り有効）**
- **同一タブ内で有効**

---

### webSQL

- ブラウザ上でSQLiteが使える
- 廃止されたからIndexedDBを使え<br/>と[googleが言っている](https://developers.google.com/web/tools/lighthouse/audits/web-sql?hl=ja)

---

### Indexed DB

- テーブル1つのみのRDB、というイメージ
  - 結合や外部キー制約はなし
  - 文字列以外も保存可能
  - key以外で検索可能
  - トランザクションがある＝非同期処理もいける
- 保存容量めっちゃいっぱい（up to quata）
  - 端末の空き容量による

---

### 使いどき

- cookieとwebSQLは無い |
- webStorage |
  - 手軽に使いたい（保存容量少ない）とき |
  - 同期処理で問題ないとき |
  - データのタブ間共有をしたくないときのみsessionStorage |
- Indexed DB |
  - ガチな（保存容量・種類が多い）とき |
  - 非同期処理（トランザクション）が必要なとき |
  - 検索したいとき |
  - 文字列以外も保存したいとき |

+++

時間があれば実演

---

## まとめ

@quote[最高の設計と実装は、お互いの尊重する雰囲気の下でプロダクションとプロダクトに対する関心が1つになったときに生まれるもので、それこそがSREが約束するものです。]

『SRE サイトリライアビリティエンジニアリング -Googleの信頼を支えるエンジニアリングチーム』
第31章 SREにおけるコミュニケーションとコラボレーションより

---
?image=assets/audience.jpg

# おわり
